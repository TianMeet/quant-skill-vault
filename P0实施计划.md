# Quant Skill Vault P0 实施计划

> 目标：将当前 MVP 提升为“可上线、可追责、可回滚、可控风险”的生产可用版本。  
> 周期：2 周（10 个工作日）  
> 优先级：P0（必须完成）

---

## 1. P0 范围（必须交付）

1. 认证与权限控制（Auth + RBAC）
2. 操作审计（谁在何时做了什么）
3. Skill 版本历史与一键回滚
4. 安全基线（限流、来源校验、危险操作保护）

---

## 2. 非目标（本阶段不做）

1. 多租户/组织级隔离
2. 高级 BI 看板
3. 复杂审批流（仅保留“发布/回滚”的基础操作）

---

## 3. 里程碑与时间安排

## Week 1

### Day 1-2：认证与权限骨架
- 接入登录态（建议：基于 session cookie 的服务端鉴权）
- 新增 `User` 数据模型，补齐最小角色模型（`admin` / `editor` / `viewer`）
- 为 API 增加统一鉴权拦截层

### Day 3-4：RBAC 落地
- 给关键接口加权限矩阵（读/写/删/导出/回滚）
- 前端按角色隐藏不可用操作按钮
- 补齐 401/403 友好提示

### Day 5：安全基线 v1
- 关键写接口增加限流（按 IP + 用户维度）
- 增加 `Origin`/`Referer` 校验与 CSRF 保护策略
- 删除/回滚类操作增加二次确认与服务端保护

## Week 2

### Day 6-7：审计日志
- 新增 `AuditLog` 模型
- 在所有写操作中记录审计事件（create/update/delete/merge/export/apply）
- 提供审计查询 API（分页）

### Day 8-9：版本历史与回滚
- 新增 `SkillVersion` 模型（快照 + 操作元信息）
- 在 Skill 写操作中自动落版本
- 增加版本列表与“回滚到该版本”接口及 UI 入口

### Day 10：联调、回归、上线准备
- API/前端/E2E 回归
- 安全与回滚演练
- 输出上线检查清单

---

## 4. 工作包拆解（按模块）

## WP1：认证与权限（Auth + RBAC）

### 目标
- 所有 API 默认拒绝匿名写操作
- 角色权限清晰，拒绝越权

### 关键改动
- 数据层（`prisma/schema.prisma`）
  - 新增 `User`、`Role`（或 `User.role` 枚举）
- 服务层
  - 新增 `src/lib/auth.ts`（获取当前用户、鉴权）
  - 新增 `src/lib/rbac.ts`（权限判断）
  - 新增 `src/middleware.ts`（路由层拦截，保护页面与 API）
- API 层
  - 在 `src/app/api/skills/**`、`src/app/api/tags/**`、`src/app/api/lint/route.ts`、`src/app/api/chat/route.ts` 增加鉴权与权限校验
- 前端
  - `src/components/nav.tsx`、`src/app/skills/**`、`src/app/tags/page.tsx` 根据角色控制操作入口

### 验收标准
- 未登录用户访问写接口返回 401
- 无权限用户返回 403
- viewer 无法创建/修改/删除/回滚

---

## WP2：审计日志（Audit Trail）

### 目标
- 能追溯每一次关键操作的人、时间、对象、结果

### 关键改动
- 数据层
  - 新增 `AuditLog` 表：`id`、`actorId`、`action`、`resourceType`、`resourceId`、`payload`、`createdAt`
- 服务层
  - 新增 `src/lib/audit.ts`（统一写日志方法）
- API 层
  - 在所有写接口中落审计：
    - Skill：创建、更新、删除、AI apply、文件增删改、导出
    - Tag：创建、重命名、删除、合并

### 验收标准
- 任一写操作后都能查到一条对应审计记录
- 审计字段完整（actor/action/resource/result）

---

## WP3：版本历史与回滚

### 目标
- Skill 任意版本可追溯、可回滚

### 关键改动
- 数据层
  - 新增 `SkillVersion` 表：`skillId`、`version`、`snapshot`、`createdBy`、`createdAt`、`reason`
- 服务层
  - 新增 `src/lib/skill-version.ts`（写版本、取版本、回滚）
- API 层
  - 新增：
    - `GET /api/skills/:id/versions`
    - `POST /api/skills/:id/rollback`
  - 在 `POST/PUT /api/skills` 与 `POST /api/skills/:id/ai/apply` 成功后自动落版本
- 前端
  - 编辑页新增“历史版本”抽屉/弹窗
  - 支持查看版本摘要并触发回滚

### 验收标准
- 每次变更自动+1版本
- 选择任意历史版本回滚后，字段与文件恢复一致
- 回滚操作写入审计日志

---

## WP4：安全基线（Risk Control）

### 目标
- 降低恶意请求、误操作和滥用风险

### 关键改动
- 限流
  - 新增 `src/lib/rate-limit.ts`
  - 对高风险接口限流：`/api/chat`、`/api/skills/*/ai/*`、`/api/skills/*/export.zip`、所有写接口
- 来源校验
  - 写接口校验 `Origin`/`Referer`
- 危险操作保护
  - 删除/回滚接口增加服务端幂等与二次确认标记（例如确认 token）
- 错误处理
  - 统一错误码与用户友好提示映射

### 验收标准
- 超限请求返回 429，前端提示明确
- 跨站伪造请求被拒绝
- 删除/回滚无确认参数不可执行

---

## 5. 数据迁移计划

1. 增量修改 `prisma/schema.prisma`
2. 生成迁移：`pnpm db:migrate`
3. 补充 seed 用户与角色（`prisma/seed.ts`）
4. 预发环境演练：
  - 迁移耗时
  - 回滚脚本可用性
  - 审计和版本表写入验证

---

## 6. 测试计划（必须通过）

## 自动化
- API 测试：
  - 401/403 权限用例
  - 审计写入用例
  - 版本创建与回滚用例
  - 限流 429 用例
- E2E：
  - 登录后创建 Skill -> 编辑 -> AI apply -> 回滚 -> 导出
  - viewer 越权尝试失败

## 手工回归
- 技能创建/编辑/删除
- 标签管理（重命名、删除、合并）
- 导出（md/json/zip）
- 对话与 AI 增强流程

---

## 7. 上线检查清单（Go/No-Go）

1. 关键 API 已鉴权且权限测试通过
2. 审计覆盖率 100%（所有写操作）
3. 版本与回滚端到端可用
4. 限流策略已生效且阈值配置化
5. 回滚预案可执行（数据库 + 应用）

---

## 8. 风险与应对

1. **风险：鉴权改造影响面大**  
   应对：先引入“只读放行、写接口强制鉴权”，再逐步收敛页面权限。
2. **风险：版本快照增大存储**  
   应对：仅保存结构化快照 + 变更摘要，超大文件走增量策略。
3. **风险：限流误伤正常用户**  
   应对：灰度开启，先告警后阻断，阈值配置化。

---

## 9. 交付物清单

1. Prisma migration（用户/审计/版本）
2. 鉴权与权限中间件
3. 审计与版本服务
4. 回滚 API + 前端入口
5. 安全基线（限流/来源校验/危险操作保护）
6. 测试报告与上线检查记录

