# Quant Skill Vault 架构图（Mermaid）

> 基于当前项目实现（Next.js + Prisma + MySQL + Chat Provider + Claude CLI）整理。

## 1. 总体架构图

```mermaid
flowchart LR
    U["用户（Browser）"]

    subgraph FE["前端层（Next.js App Router + React）"]
        P["页面路由<br/>/skills /skills/new /skills/[id] /skills/[id]/edit"]
        F["SkillForm（结构化表单）"]
        C["ChatPanel（SSE 对话）"]
    end

    subgraph API["API 层（Route Handlers）"]
        S["/api/skills/*<br/>CRUD + Files + Export + AI Propose/Apply"]
        T["/api/tags"]
        L["/api/lint"]
        H["/api/chat（SSE）"]
    end

    subgraph CORE["核心服务层（src/lib）"]
        Z["Zod Schemas<br/>请求校验"]
        G["Lint Gate<br/>lintSkill / lintSkillPackage"]
        M["Markdown Renderer<br/>SKILL.md 渲染"]
        R["Claude CLI Runner<br/>spawn(shell:false)"]
        CP["Chat Provider Adapter<br/>mock / anthropic"]
    end

    subgraph DATA["数据层"]
        PR["Prisma ORM"]
        DB[("MySQL 8.0")]
    end

    subgraph EXT["外部依赖"]
        AN["Anthropic Messages API"]
        CL["Claude CLI（本地进程）"]
    end

    U --> P
    P --> F
    P --> C

    P --> S
    P --> T
    P --> L
    C -. "SSE" .-> H

    S --> Z
    S --> G
    S --> M
    S --> R
    T --> PR
    L --> G
    H --> CP

    S --> PR
    PR --> DB

    CP --> AN
    R --> CL

    S -- "ZIP / Markdown / JSON 导出" --> U
    H -- "stream events" --> C
```

## 2. 数据模型关系图

```mermaid
erDiagram
    SKILLS ||--o{ SKILL_FILES : contains
    SKILLS ||--o{ SKILL_TAGS : maps
    TAGS ||--o{ SKILL_TAGS : maps

    SKILLS {
        bigint id PK
        string title
        string slug UK
        text summary
        text inputs
        text outputs
        json steps
        text risks
        json triggers
        json guardrails
        json tests
        datetime created_at
        datetime updated_at
    }

    SKILL_FILES {
        bigint id PK
        bigint skill_id FK
        string path
        string mime
        boolean is_binary
        text content_text
        blob content_bytes
    }

    TAGS {
        bigint id PK
        string name UK
    }

    SKILL_TAGS {
        bigint skill_id FK
        bigint tag_id FK
    }
```

## 3. 关键流程图（对话式创建 + 实时回填）

```mermaid
sequenceDiagram
    participant User as 用户
    participant UI as ChatPanel/SkillForm
    participant ChatAPI as /api/chat
    participant Provider as Chat Provider（mock/anthropic）
    participant SkillsAPI as /api/skills
    participant DB as MySQL

    User->>UI: 输入需求
    UI->>ChatAPI: 发起 SSE 请求
    ChatAPI->>Provider: 生成流式响应
    Provider-->>ChatAPI: text_delta / tool_use(update_skill_draft)
    ChatAPI-->>UI: SSE 事件流
    UI->>UI: 渐进回填表单字段

    User->>UI: 确认创建
    UI->>SkillsAPI: POST /api/skills
    SkillsAPI->>SkillsAPI: Zod 校验 + slug 生成
    SkillsAPI->>DB: 写入 Skill / Tags / Files
    DB-->>SkillsAPI: 成功
    SkillsAPI-->>UI: 返回 skill id
```

## 4. 关键流程图（AI Tab：Propose → Apply）

```mermaid
sequenceDiagram
    participant User as 用户
    participant EditUI as 编辑页 AI Tab
    participant AIAPI as /api/skills/[id]/ai/*
    participant CLI as Claude CLI Runner
    participant Lint as Lint Gate
    participant DB as MySQL

    User->>EditUI: 选择 action + instruction
    EditUI->>AIAPI: POST /ai/propose
    AIAPI->>CLI: 构建 prompt 并执行（shell:false）
    CLI-->>AIAPI: changeSet
    AIAPI->>Lint: 预校验（lint preview）
    AIAPI-->>EditUI: 返回变更预览

    User->>EditUI: 点击 Apply
    EditUI->>AIAPI: POST /ai/apply
    AIAPI->>AIAPI: validateChangeSet + path gate
    AIAPI->>DB: Prisma $transaction 写入
    DB-->>AIAPI: 成功
    AIAPI-->>EditUI: 返回更新后的 Skill
```

