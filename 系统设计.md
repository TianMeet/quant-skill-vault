# Quant Skill Vault — 系统设计文档

> 量化技能库管理平台，用于创建、管理、校验和导出 Claude Code Skills 合规技能包。

---

## 1. 系统概述

Quant Skill Vault 是一个 **Skill 协议管理平台**，核心目标是将自然语言描述的技能（Skill）结构化为符合 Claude Code Skills 规范的协议卡片，并支持多格式合规导出（ZIP / Markdown / JSON）。

系统提供两种 Skill 创建方式：
- **表单驱动**：通过结构化表单手动填写所有字段
- **对话驱动**：通过 AI 对话逐步收集信息，实时回填表单，降低创建门槛

---

## 2. 技术栈

| 层级 | 技术 |
|------|------|
| **前端框架** | Next.js 16 (App Router) + React 19 + TypeScript |
| **样式** | TailwindCSS 4 + Radix UI 原语组件 |
| **图标** | Lucide React |
| **数据校验** | Zod 4 |
| **数据库** | MySQL 8.0（本地） |
| **ORM** | Prisma 5 |
| **AI 集成** | Anthropic SDK（Chat 面板）+ Claude CLI（AI Tab） |
| **导出** | archiver（ZIP）、js-yaml（YAML frontmatter） |
| **测试** | Vitest（单元 + API）、Playwright（E2E） |
| **包管理** | pnpm |

---

## 3. 系统架构

```
┌──────────────────────────────────────────────────────────────┐
│                        Browser (React)                       │
│                                                              │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────┐ │
│  │ 列表页    │  │ 详情页    │  │ 编辑页    │  │ 新建页        │ │
│  │ /skills  │  │ /skills/ │  │ /skills/ │  │ /skills/new  │ │
│  │          │  │ [id]     │  │ [id]/edit│  │ + ChatPanel  │ │
│  └──────────┘  └──────────┘  └──────────┘  └──────────────┘ │
│                                    │              │          │
│                              SkillForm      ChatPanel        │
│                              (表单组件)    (对话面板)          │
└───────────────────────────────┬────────────────┬─────────────┘
                                │ REST API       │ SSE Stream
                                ▼                ▼
┌──────────────────────────────────────────────────────────────┐
│                   Next.js API Routes (Node.js)               │
│                                                              │
│  ┌────────────────┐  ┌──────────┐  ┌──────────────────────┐ │
│  │ /api/skills/*  │  │ /api/tags│  │ /api/chat (SSE)      │ │
│  │ CRUD + Export  │  │          │  │ Mock / Anthropic     │ │
│  ├────────────────┤  └──────────┘  └──────────────────────┘ │
│  │ /api/skills/   │  ┌──────────┐  ┌──────────────────────┐ │
│  │ [id]/ai/*     │  │ /api/lint│  │ Claude CLI Runner    │ │
│  │ Propose+Apply │  │          │  │ (spawn, shell:false) │ │
│  └────────────────┘  └──────────┘  └──────────────────────┘ │
└───────────────────────────────┬──────────────────────────────┘
                                │ Prisma ORM
                                ▼
                    ┌──────────────────────┐
                    │   MySQL 8.0 (本地)    │
                    │   quant_skill_vault   │
                    └──────────────────────┘
```

---

## 4. 数据模型

### 4.1 ER 关系

```
Skill ──1:N── SkillFile      (附属文件)
Skill ──M:N── Tag            (通过 SkillTag 关联)
```

### 4.2 核心表

#### skills

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK | 自增主键 |
| title | VARCHAR(200) | 技能标题 |
| slug | VARCHAR(64) UNIQUE | URL 友好标识，自动生成 |
| summary | TEXT | 摘要描述 |
| inputs | TEXT | 输入说明 |
| outputs | TEXT | 输出说明 |
| steps | JSON | 执行步骤（string[]，3~7 项） |
| risks | TEXT | 风险说明 |
| triggers | JSON | 触发短语（string[]，>=3 项） |
| guardrails | JSON | 安全护栏配置 |
| tests | JSON | 测试用例（{name, input, expected_output}[]） |
| created_by | VARCHAR(150) | 创建人 |
| updated_by | VARCHAR(150) | 更新人 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

#### skill_files

| 字段 | 类型 | 说明 |
|------|------|------|
| id | BIGINT PK | 自增主键 |
| skill_id | INT FK | 关联 Skill |
| path | VARCHAR(500) | 相对路径（如 `references/rules.md`） |
| mime | VARCHAR(200) | MIME 类型 |
| is_binary | BOOLEAN | 是否为二进制文件 |
| content_text | MEDIUMTEXT | 文本内容（文本文件） |
| content_bytes | MEDIUMBLOB | 二进制内容（二进制文件） |
| UNIQUE(skill_id, path) | | 同一 Skill 下路径唯一 |

#### tags / skill_tags

标签表和多对多关联表，支持按标签筛选 Skill。

### 4.3 Guardrails 结构

```typescript
{
  allowed_tools: string[]           // 允许使用的工具列表
  disable_model_invocation: boolean // 是否禁用模型调用
  user_invocable: boolean           // 是否允许用户直接调用
  stop_conditions: string[]         // 停止条件（>=1 项）
  escalation: 'REVIEW' | 'BLOCK' | 'ASK_HUMAN'  // 升级策略
}
```

---

## 5. 功能模块

### 5.1 Skill CRUD

| 接口 | 方法 | 功能 |
|------|------|------|
| `/api/skills` | GET | 列表查询，支持 `query` 关键词 + `tags` 标签过滤 |
| `/api/skills` | POST | 创建 Skill（Zod 校验 + 自动生成 slug） |
| `/api/skills/[id]` | GET | 获取单个 Skill 详情 |
| `/api/skills/[id]` | PUT | 更新 Skill（部分更新） |
| `/api/skills/[id]` | DELETE | 删除 Skill（级联删除关联文件和标签） |

**数据校验（Zod Schema）**：
- title：1~200 字符
- steps：3~7 项
- triggers：>=3 项
- tests：>=1 条用例
- guardrails.stop_conditions：>=1 条
- guardrails.escalation：REVIEW / BLOCK / ASK_HUMAN 三选一

### 5.2 标签管理

| 接口 | 方法 | 功能 |
|------|------|------|
| `/api/tags` | GET | 获取全部标签（含关联 Skill 数量） |
| `/api/tags` | POST | 创建标签（upsert，去重） |

### 5.3 Supporting Files 管理

| 接口 | 方法 | 功能 |
|------|------|------|
| `/api/skills/[id]/files` | GET | 文件列表 / 单文件内容查询 |
| `/api/skills/[id]/files` | POST | 创建文件 |
| `/api/skills/[id]/files?path=` | PUT | 更新文件内容 |
| `/api/skills/[id]/files?path=` | DELETE | 删除文件 |

**路径安全策略（Path Gate）**：
- 仅允许 `references/`、`examples/`、`scripts/`、`assets/`、`templates/` 目录
- 禁止绝对路径、`..` 回溯、反斜杠
- 禁止创建 `SKILL.md`（由系统自动生成）
- 文本文件上限 200KB，二进制文件上限 2MB

### 5.4 Lint Gate（合规校验）

**两级校验**：

| 层级 | 函数 | 校验范围 |
|------|------|---------|
| 基础 | `lintSkill()` | slug 格式、triggers>=3、steps 3~7、tests>=1、stop_conditions>=1、escalation 枚举、description 长度<=1024 |
| 完整 | `lintSkillPackage()` | 基础校验 + 文件路径合法性 + SKILL.md 内相对链接完整性 |

- 客户端可通过 `/api/lint` 实时校验
- 导出接口自动执行 Lint Gate，不通过返回 400 + 错误列表

### 5.5 多格式导出

| 接口 | 格式 | 说明 |
|------|------|------|
| `/api/skills/[id]/export.md` | Markdown | YAML frontmatter + 结构化 Markdown，符合 Claude Code Skills 规范 |
| `/api/skills/[id]/export.json` | JSON | 结构化 JSON，含 description、guardrails 展平字段 |
| `/api/skills/[id]/export.zip` | ZIP | `<slug>/SKILL.md` + 全部 supporting files，archiver 压缩 |

**SKILL.md 结构**：

```markdown
---
name: <slug>
description: "This skill should be used when ..."
allowed-tools: [...]
disable-model-invocation: false
user-invocable: true
---

# <title>

## Purpose / ## Inputs / ## Outputs / ## Workflow / ## Pitfalls
## Guardrails / ## Tests / ## Supporting files
```

### 5.6 AI Tab（Claude CLI 集成）

编辑页的 AI Tab 通过本机 Claude CLI 生成/修改 Skill 内容。

**流程**：`Propose → Preview → Apply`

```
用户操作                   API                        Claude CLI
  │                        │                            │
  │── 选择 action ────────→│                            │
  │   + instruction        │── POST /ai/propose ──────→│
  │                        │   构建 prompt + schema     │── headless print ──→
  │                        │                            │← structured_output ─┤
  │←── changeSet ──────────│← 解析 + lint preview ─────│
  │   (预览 diff)          │                            │
  │                        │                            │
  │── 确认 Apply ─────────→│                            │
  │                        │── POST /ai/apply ─────────→│
  │                        │   校验 + 事务写入 DB        │
  │←── updated skill ──────│                            │
```

**支持的 Action**：
- `update-skill`：优化 Skill 内容
- `fix-lint`：自动修复 lint 错误
- `create-supporting-files`：生成参考文件

**安全策略**：
- `spawn(command, args, {shell: false})` 防止命令注入
- 禁用所有 Claude 内置工具（`--tools ""`）
- Prompt 长度限制 8KB
- ChangeSet 写入���经过 `validateChangeSet()` 校验（schema + path gate + size gate）
- 数据库写入使用 `$transaction` 保证原子性

### 5.7 对话式创建（Chat Panel）

新建页右侧的 AI 对话面板，通过多轮对话渐进式收集 Skill 信息并实时填充表单。

**架构**：

```
ChatPanel (React)
    │
    │── SSE Stream ──→ /api/chat ──→ ChatProviderAdapter
    │                                     │
    │                          ┌──────────┴──────────┐
    │                    MockProvider         AnthropicProvider
    │                   (本地开发/测试)        (Anthropic API)
    │
    ├── text_delta → 渲染对话气泡
    ├── tool_use(update_skill_draft) → 渐进回填左侧表单
    └── tool_use(create_skill) → 最终创建 Skill
```

**Provider 策略**（通过 `CHAT_PROVIDER` 环境变量切换）：
- `mock`：本地 mock 流式事件，无需外部依赖，推荐开发/测试使用
- `anthropic`：调用 Anthropic Messages API，需要 `ANTHROPIC_API_KEY`

**Tool 定义**：
- `update_skill_draft`：渐进式更新表单草稿，所有字段可选
- `create_skill`：所有必填字段齐备后最终创建，严格校验

**对话策略**：按 title/summary → inputs/outputs → steps → triggers → guardrails → tests → risks/tags 的顺序逐步引导，每完成一个话题就调用 `update_skill_draft` 实时回填。

---

## 6. 前端页面

| 路由 | 页面 | 功能 |
|------|------|------|
| `/` | 首页 | 自动重定向到 `/skills` |
| `/skills` | 列表页 | 卡片网格展示，关键词搜索 + 标签筛选，快捷导出 ZIP |
| `/skills/new` | 新建页 | SkillForm + ChatPanel（自动打开对话面板） |
| `/skills/[id]` | 详情页 | 字段分区展示 + Lint 校验 + 多格式导出 + 文件列表 |
| `/skills/[id]/edit` | 编辑页 | SkillForm（含 AI Tab） |

**全局布局**：
- Nav 导航栏 + ThemeProvider（深色/浅色主题切换）
- ChatProvider + ChatPanel 全局挂载

---

## 7. 安全设计

| 维度 | 措施 |
|------|------|
| **路径安全** | Path Gate 白名单目录，禁止 `..`、绝对路径、反斜杠 |
| **命令注入防护** | Claude CLI 使用 `spawn(cmd, args, {shell: false})` |
| **文件大小限制** | 文本 200KB、二进制 2MB、Prompt 8KB |
| **SKILL.md 保护** | 禁止手动创建/修改，由系统自动从 skillPatch 渲染生成 |
| **数据校验** | Zod Schema 前置校验所有输入；ChangeSet 入库前二次校验 |
| **事务保护** | AI Apply 使用 Prisma `$transaction` 原子写入 |
| **Slug 唯一性** | 数据库 UNIQUE 约束 + 应用层冲突处理（409） |

---

## 8. 测试策略

| 层级 | 工具 | 覆盖范围 | 命令 |
|------|------|---------|------|
| 单元测试 | Vitest | slugify、lint、markdown 渲染、文件路径校验 | `pnpm test:unit` |
| API 测试 | Vitest + Prisma Mock | Skills CRUD、Files CRUD、Export、AI propose/apply、Chat | `pnpm test:api` |
| E2E 测试 | Playwright | 完整用户流程 | `pnpm test:e2e` |

---

## 9. 环境变量

| 变量 | 说明 | 默认值 |
|------|------|--------|
| `DATABASE_URL` | MySQL 连接字符串 | `mysql://root:root123@localhost:3306/quant_skill_vault` |
| `NEXT_PUBLIC_APP_URL` | 应用访问地址 | `http://localhost:3000` |
| `CLAUDE_BIN` | Claude CLI 可执行路径 | `claude` |
| `CLAUDE_MODEL` | Claude 模型 | `sonnet` |
| `CLAUDE_MAX_TURNS` | 最大对话轮次 | `3` |
| `CLAUDE_MAX_BUDGET_USD` | 单次预算上限 | `1` |
| `CLAUDE_TIMEOUT_MS` | CLI 超时时间 | `60000` |
| `CHAT_PROVIDER` | Chat 面板 Provider | `mock`（开发）/ `anthropic`（生产） |
| `ANTHROPIC_API_KEY` | Anthropic API Key | — |
| `ANTHROPIC_BASE_URL` | Anthropic API 自定义域名 | — |

---

## 10. 项目目录结构

```
src/
├── app/
│   ├── api/
│   │   ├── skills/                  # Skill CRUD + Export
│   │   │   ├── route.ts             # GET 列表 / POST 创建
│   │   │   └── [id]/
│   │   │       ├── route.ts         # GET / PUT / DELETE
│   │   │       ├── files/route.ts   # Supporting Files CRUD
│   │   │       ├── ai/propose/route.ts  # AI 变更提案
│   │   │       ├── ai/apply/route.ts    # AI 变更应用
│   │   │       ├── export.md/route.ts   # Markdown 导出
│   │   │       ├── export.json/route.ts # JSON 导出
│   │   │       └── export.zip/route.ts  # ZIP 导出
│   │   ├── tags/route.ts            # 标签管理
│   │   ├── chat/route.ts            # Chat SSE 流式接口
│   │   ├── lint/route.ts            # 客户端 Lint 校验
│   │   └── __tests__/               # API 测试
│   ├── skills/
│   │   ├── page.tsx                 # 列表页
│   │   ├── new/page.tsx             # 新建页
│   │   └── [id]/
│   │       ├── page.tsx             # 详情页
│   │       └── edit/page.tsx        # 编辑页
│   ├── layout.tsx                   # 全局布局
│   └── page.tsx                     # 首页（重定向）
├── components/
│   ├── skill-form.tsx               # Skill 表单组件
│   ├── chat-panel.tsx               # Chat 对话面板
│   ├── chat-message.tsx             # 聊天消息组件
│   ├── chat-skill-preview.tsx       # Skill 预览组件
│   ├── nav.tsx                      # 导航栏
│   ├── theme-toggle.tsx             # 主题切换
│   └── ui/                          # Radix UI 基础组件
├── lib/
│   ├── types.ts                     # 核心类型定义
│   ├── zod-schemas.ts               # Zod 校验 Schema
│   ├── prisma.ts                    # Prisma 客户端单例
│   ├── slugify.ts                   # Slug 生成
│   ├── lint.ts                      # Lint Gate 校验引擎
│   ├── markdown.ts                  # SKILL.md 渲染器
│   ├── skill-files.ts               # 文件路径校验
│   ├── ai/
│   │   ├── types.ts                 # ChangeSet 类型定义
│   │   ├── schema.ts                # ChangeSet JSON Schema
│   │   └── claudeRunner.ts          # Claude CLI 安全调用器
│   ├── chat/
│   │   ├── types.ts                 # Chat 类型定义
│   │   ├── system-prompt.ts         # Chat 系统提示词
│   │   ├── tool-definitions.ts      # Tool 定义（create_skill / update_skill_draft）
│   │   ├── chat-context.tsx         # Chat React Context
│   │   ├── use-chat.ts              # Chat Hook
│   │   └── providers/
│   │       ├── types.ts             # Provider 适配器接口
│   │       ├── index.ts             # Provider 工厂
│   │       ├── anthropic.ts         # Anthropic API Provider
│   │       └── mock.ts              # Mock Provider
│   ├── theme-context.tsx            # 主题 Context
│   └── utils.ts                     # 工具函数
prisma/
├── schema.prisma                    # 数据模型定义
└── seed.ts                          # 种子数据（3 个示例 Skill）
```
