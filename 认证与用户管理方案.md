# Quant Skill Vault 认证与用户管理方案（钉钉 SSO + 可切换模式）

## 1. 背景与目标
- 当前系统主要面向量化团队内部使用，现阶段用户规模较小。
- 公司已有钉钉体系，长期目标是接入钉钉 SSO 统一身份。
- 短期希望保留灵活性：可按环境或阶段切换认证策略。

本方案目标：
- 提供一套完整、可分阶段实施的认证与用户管理设计。
- 在不影响当前 MVP 迭代速度的前提下，先完成方案存档，后续按需启用。

## 2. 认证模式设计（可切换）
定义 `AUTH_MODE`，支持三种模式：

1. `dingtalk_only`
- 仅允许钉钉 SSO 登录。
- 适用于生产正式上线后。

2. `mixed`（推荐未来默认）
- 优先钉钉 SSO。
- 可选本地应急账号（仅管理员、可配置开关）。
- 适用于钉钉服务异常或内网联调场景。

3. `local_only`（开发调试）
- 仅本地账号登录。
- 用于开发、联调、离线环境。

## 3. 建议的阶段策略（结合当前“暂不优先”决策）
### Phase A（现在）
- 暂不落地用户系统。
- 保持单团队低门槛使用，继续推进核心业务功能。
- 文档存档，先统一未来实施方向。

### Phase B（需要时快速落地）
- 接入钉钉 SSO。
- 增加最小 RBAC（`admin/editor/viewer`）。
- 保护所有写接口和敏感页面。

### Phase C（稳定后增强）
- 用户管理后台（角色分配、启停、审计）。
- 钉钉组织信息同步（可选）。
- 更细粒度权限与审计报表。

## 4. 系统架构（目标态）
### 4.1 认证链路
- 登录页根据 `AUTH_MODE` 显示可用登录方式。
- 钉钉登录：前端跳转钉钉授权 -> 回调 `/api/auth/callback/dingtalk`。
- 服务端完成 token/code 校验，获取钉钉用户唯一标识。
- 若本地不存在用户，按策略创建（JIT Provisioning，可开关）。
- 颁发服务端会话（`httpOnly` + `secure` cookie）。

### 4.2 鉴权中间件
- 页面层：未登录访问受保护页面时跳转登录页。
- API 层：统一校验会话与角色，返回标准错误码。
- 管理接口仅 `admin` 可访问。

### 4.3 角色权限（P0）
- `admin`：用户管理、系统配置、全量读写。
- `editor`：技能创建/编辑/发布、标签管理。
- `viewer`：只读查看与导出。

## 5. 数据模型（Prisma 目标草案）
建议新增以下模型：

1. `User`
- `id`
- `displayName`
- `email`（可空）
- `status`（`active`/`disabled`）
- `lastLoginAt`
- `createdAt` / `updatedAt`

2. `Identity`
- `id`
- `userId`
- `provider`（`dingtalk` / `local`）
- `externalId`（钉钉 unionId/openId）
- `providerMeta`（Json）
- `createdAt` / `updatedAt`
- 唯一约束：`provider + externalId`

3. `Role` / `UserRole`
- 角色定义与用户角色关联。

4. `Session`
- 会话管理（token hash、过期时间、撤销状态、设备信息）。

5. `AuditLog`
- 关键操作审计：登录、登出、角色变更、敏感数据操作。

## 6. 配置与开关
建议环境变量：

```bash
AUTH_MODE=mixed
ALLOW_LOCAL_FALLBACK=true
ENABLE_JIT_PROVISIONING=true
DINGTALK_CLIENT_ID=xxx
DINGTALK_CLIENT_SECRET=xxx
DINGTALK_REDIRECT_URI=https://your-domain/api/auth/callback/dingtalk
SESSION_COOKIE_NAME=qsv_session
SESSION_TTL_HOURS=12
```

## 7. 安全基线
- cookie: `httpOnly`, `secure`, `sameSite=lax`。
- 登录与回调接口启用限流与失败保护。
- 严禁前端单独判断权限，必须在 API 层强校验。
- 敏感操作必须记录 `AuditLog`。
- 管理员应急账号默认关闭，按配置显式开启。

## 8. 前端与交互建议
- 登录页：按模式展示“钉钉登录/本地登录”入口。
- 全局状态：展示当前登录用户与角色。
- 无权限页面：统一友好提示，不暴露内部实现细节。
- 会话过期：统一弹出提示并跳转登录页。

## 9. 与当前系统的耦合点
- `middleware.ts`：页面级登录拦截。
- `src/app/api/**`：统一接入鉴权包装器（如 `requireAuth` / `requireRole`）。
- 技能、标签、文件、AI 增强等写接口：至少要求 `editor`。
- 系统配置、用户管理接口：要求 `admin`。

## 10. 实施清单（未来启动时）
1. 落库：新增用户、身份、会话、角色、审计模型并迁移。
2. 接入钉钉 SSO 回调与会话签发。
3. 增加 API 鉴权中间层与角色守卫。
4. 登录页/用户菜单/退出登录闭环。
5. 管理后台最小版本（用户列表 + 角色分配）。
6. 回归测试：登录、续期、登出、权限拒绝、审计落库。

## 11. 当前结论（执行决策）
- 本方案已完成存档，作为后续认证体系的统一实施基线。
- 现阶段按你的决策：**不立即开发用户系统**，继续优先业务功能迭代。
- 当团队规模或合规要求提升时，按本方案从 Phase B 启动即可。
